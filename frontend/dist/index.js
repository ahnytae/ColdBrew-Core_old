import require$$0 from"fs";import require$$1 from"url";import require$$2 from"child_process";import require$$3 from"http";import require$$4 from"https";import require$$0$2 from"stream";import require$$0$1 from"zlib";import require$$3$1 from"net";import require$$4$1 from"tls";import require$$5 from"crypto";import require$$0$3 from"events";function _mergeNamespaces(s,e){return e.forEach(function(r){r&&"string"!=typeof r&&!Array.isArray(r)&&Object.keys(r).forEach(function(e){var t;"default"===e||e in s||(t=Object.getOwnPropertyDescriptor(r,e),Object.defineProperty(s,e,t.get?t:{enumerable:!0,get:function(){return r[e]}}))})}),Object.freeze(s)}class ColdBrew{constructor(){}static MY_STREAM;static ROOM_NAME;static get MyStream(){return ColdBrew.MY_STREAM}static set MyStream(e){ColdBrew.MY_STREAM=e}static get RoomName(){return ColdBrew.ROOM_NAME}static set RoomName(e){ColdBrew.ROOM_NAME=e}}class GetUserDevices extends ColdBrew{static constraints={audio:!0,video:!0};get currentVideoTrack(){const e=ColdBrew.MyStream;return e.getVideoTracks()[0]}static async getDeviceStream(e){try{var t=await navigator.mediaDevices.getUserMedia(e?{audio:!0,video:{deviceId:{exact:e}}}:GetUserDevices.constraints);return t?{isError:!1,stream:ColdBrew.MyStream=t}:{isError:!0,errorData:{name:"get media failed"}}}catch(e){return e instanceof DOMException?{isError:!0,errorData:{name:e.name,message:e.message}}:{isError:!0,errorData:{name:"exception failed"}}}}async getAllDeviceLists(){try{var e=await navigator.mediaDevices.enumerateDevices();return e?{isError:!1,list:e}:{isError:!0,errorData:{name:"Get List failed"}}}catch(e){return{isError:!0,errorData:{name:"Get List failed"}}}}static async getSelectDeviceList(e){const t=await navigator.mediaDevices.enumerateDevices();if("video"===e)try{return t.filter(e=>"videoinput"===e.kind)}catch{console.error("%c [ColdBrew] failed select get device list","color: red")}try{return t.filter(e=>"audioinput"===e.kind)}catch{console.error("%c [ColdBrew] failed select get device list","color: red")}}static async attachLocalVideo(e,t){try{e.srcObject=t}catch{console.error("%c [ColdBrew] type check video Element or stream","color: red")}}static changeDeviceStatus(e,t){console.log("status",e,t);const r=ColdBrew.MyStream;if("video"!==e){if("mic"===e)try{r.getAudioTracks().map(e=>e.enabled=t)}catch{console.error("%c [ColdBrew] failed mute Mic","color: red")}}else try{r.getVideoTracks().map(e=>e.enabled=t)}catch{console.error("%c [ColdBrew] failed mute Mic","color: red")}}}class GetUserDevicesError extends Error{}var re=/^(?:(?![^:@]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,parts=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],parseuri=function(e){var t=e,r=e.indexOf("["),s=e.indexOf("]");-1!=r&&-1!=s&&(e=e.substring(0,r)+e.substring(r,s).replace(/:/g,";")+e.substring(s,e.length));for(var o=re.exec(e||""),n={},i=14;i--;)n[parts[i]]=o[i]||"";return-1!=r&&-1!=s&&(n.source=t,n.host=n.host.substring(1,n.host.length-1).replace(/;/g,":"),n.authority=n.authority.replace("[","").replace("]","").replace(/;/g,":"),n.ipv6uri=!0),n.pathNames=pathNames(n,n.path),n.queryKey=queryKey(n,n.query),n};function pathNames(e,t){var r=t.replace(/\/{2,9}/g,"/").split("/");return"/"!=t.substr(0,1)&&0!==t.length||r.splice(0,1),"/"==t.substr(t.length-1,1)&&r.splice(r.length-1,1),r}function queryKey(e,t){var s={};return t.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(e,t,r){t&&(s[t]=r)}),s}function url(e,t="",r){let s=e;r=r||"undefined"!=typeof location&&location,"string"==typeof(e=null==e?r.protocol+"//"+r.host:e)&&("/"===e.charAt(0)&&(e="/"===e.charAt(1)?r.protocol+e:r.host+e),/^(https?|wss?):\/\//.test(e)||(e=void 0!==r?r.protocol+"//"+e:"https://"+e),s=parseuri(e)),s.port||(/^(http|ws)$/.test(s.protocol)?s.port="80":/^(http|ws)s$/.test(s.protocol)&&(s.port="443")),s.path=s.path||"/";e=-1!==s.host.indexOf(":")?"["+s.host+"]":s.host;return s.id=s.protocol+"://"+e+":"+s.port+t,s.href=s.protocol+"://"+e+(r&&r.port===s.port?"":":"+s.port),s}var fs=require$$0,Url=require$$1,spawn=require$$2.spawn,XMLHttpRequest_1=XMLHttpRequest$1;function XMLHttpRequest$1(u){u=u||{};var p,f,m=this,_=require$$3,y=require$$4,g={},s=!1,e={"User-Agent":"node-XMLHttpRequest",Accept:"*/*"},E=Object.assign({},e),o=["accept-charset","accept-encoding","access-control-request-headers","access-control-request-method","connection","content-length","content-transfer-encoding","cookie","cookie2","date","expect","host","keep-alive","origin","referer","te","trailer","transfer-encoding","upgrade","via"],i=["TRACE","TRACK","CONNECT"],k=!1,b=!1,a=!1,n={};this.UNSENT=0,this.OPENED=1,this.HEADERS_RECEIVED=2,this.LOADING=3,this.DONE=4,this.readyState=this.UNSENT,this.onreadystatechange=null,this.responseText="",this.responseXML="",this.status=null,this.statusText=null;this.open=function(e,t,r,s,o){if(this.abort(),a=b=!1,!(n=e)||-1!==i.indexOf(n))throw new Error("SecurityError: Request method not allowed");var n;g={method:e,url:t.toString(),async:"boolean"!=typeof r||r,user:s||null,password:o||null},v(this.OPENED)},this.setDisableHeaderCheck=function(e){s=e},this.setRequestHeader=function(e,t){if(this.readyState!=this.OPENED)throw new Error("INVALID_STATE_ERR: setRequestHeader can only be called when state is OPEN");if(r=e,!(s||r&&-1===o.indexOf(r.toLowerCase())))return console.warn('Refused to set unsafe header "'+e+'"'),!1;var r;if(k)throw new Error("INVALID_STATE_ERR: send flag is true");return E[e]=t,!0},this.getResponseHeader=function(e){return"string"==typeof e&&this.readyState>this.OPENED&&f.headers[e.toLowerCase()]&&!b?f.headers[e.toLowerCase()]:null},this.getAllResponseHeaders=function(){if(this.readyState<this.HEADERS_RECEIVED||b)return"";var e,t="";for(e in f.headers)"set-cookie"!==e&&"set-cookie2"!==e&&(t+=e+": "+f.headers[e]+"\r\n");return t.substr(0,t.length-2)},this.getRequestHeader=function(e){return"string"==typeof e&&E[e]?E[e]:""},this.send=function(e){if(this.readyState!=this.OPENED)throw new Error("INVALID_STATE_ERR: connection must be opened before send() is called");if(k)throw new Error("INVALID_STATE_ERR: send has already been called");var t,r=!1,s=!1,o=Url.parse(g.url);switch(o.protocol){case"https:":r=!0;case"http:":t=o.hostname;break;case"file:":s=!0;break;case void 0:case"":t="localhost";break;default:throw new Error("Protocol not supported.")}if(s){if("GET"!==g.method)throw new Error("XMLHttpRequest: Only GET method is supported");if(g.async)fs.readFile(unescape(o.pathname),"utf8",function(e,t){e?m.handleError(e,e.errno||-1):(m.status=200,m.responseText=t,v(m.DONE))});else try{this.responseText=fs.readFileSync(unescape(o.pathname),"utf8"),this.status=200,v(m.DONE)}catch(e){this.handleError(e,e.errno||-1)}}else{var n=o.port||(r?443:80),i=o.pathname+(o.search||"");E.Host=t,r&&443===n||80===n||(E.Host+=":"+o.port),g.user&&(void 0===g.password&&(g.password=""),a=new Buffer(g.user+":"+g.password),E.Authorization="Basic "+a.toString("base64")),"GET"===g.method||"HEAD"===g.method?e=null:e?(E["Content-Length"]=Buffer.isBuffer(e)?e.length:Buffer.byteLength(e),E["Content-Type"]||(E["Content-Type"]="text/plain;charset=UTF-8")):"POST"===g.method&&(E["Content-Length"]=0);var a=u.agent||!1,i={host:t,port:n,path:i,method:g.method,headers:E,agent:a};if(r&&(i.pfx=u.pfx,i.key=u.key,i.passphrase=u.passphrase,i.cert=u.cert,i.ca=u.ca,i.ciphers=u.ciphers,i.rejectUnauthorized=!1!==u.rejectUnauthorized),b=!1,g.async){var c=(r?y:_).request;k=!0,m.dispatchEvent("readystatechange");var h=function(e){if(302===(f=e).statusCode||303===f.statusCode||307===f.statusCode){g.url=f.headers.location;e=Url.parse(g.url);t=e.hostname;e={hostname:e.hostname,port:e.port,path:e.path,method:303===f.statusCode?"GET":g.method,headers:E};return r&&(e.pfx=u.pfx,e.key=u.key,e.passphrase=u.passphrase,e.cert=u.cert,e.ca=u.ca,e.ciphers=u.ciphers,e.rejectUnauthorized=!1!==u.rejectUnauthorized),void(p=c(e,h).on("error",l)).end()}f&&f.setEncoding&&f.setEncoding("utf8"),v(m.HEADERS_RECEIVED),m.status=f.statusCode,f.on("data",function(e){e&&(m.responseText+=e),k&&v(m.LOADING)}),f.on("end",function(){k&&(k=!1,v(m.DONE))}),f.on("error",function(e){m.handleError(e)})},l=function(e){m.handleError(e)};p=c(i,h).on("error",l),u.autoUnref&&p.on("socket",e=>{e.unref()}),e&&p.write(e),p.end(),m.dispatchEvent("loadstart")}else{var a=".node-xmlhttprequest-content-"+process.pid,d=".node-xmlhttprequest-sync-"+process.pid;fs.writeFileSync(d,"","utf8");for(e="var http = require('http'), https = require('https'), fs = require('fs');var doRequest = http"+(r?"s":"")+".request;var options = "+JSON.stringify(i)+";var responseText = '';var req = doRequest(options, function(response) {response.setEncoding('utf8');response.on('data', function(chunk) {  responseText += chunk;});response.on('end', function() {fs.writeFileSync('"+a+"', 'NODE-XMLHTTPREQUEST-STATUS:' + response.statusCode + ',' + responseText, 'utf8');fs.unlinkSync('"+d+"');});response.on('error', function(error) {fs.writeFileSync('"+a+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');fs.unlinkSync('"+d+"');});}).on('error', function(error) {fs.writeFileSync('"+a+"', 'NODE-XMLHTTPREQUEST-ERROR:' + JSON.stringify(error), 'utf8');fs.unlinkSync('"+d+"');});"+(e?"req.write('"+JSON.stringify(e).slice(1,-1).replace(/'/g,"\\'")+"');":"")+"req.end();",e=spawn(process.argv[0],["-e",e]);fs.existsSync(d););m.responseText=fs.readFileSync(a,"utf8"),e.stdin.end(),fs.unlinkSync(a),m.responseText.match(/^NODE-XMLHTTPREQUEST-ERROR:/)?(a=m.responseText.replace(/^NODE-XMLHTTPREQUEST-ERROR:/,""),m.handleError(a,503)):(m.status=m.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:([0-9]*),.*/,"$1"),m.responseText=m.responseText.replace(/^NODE-XMLHTTPREQUEST-STATUS:[0-9]*,(.*)/,"$1"),v(m.DONE))}}},this.handleError=function(e,t){this.status=t||0,this.statusText=e,this.responseText=e.stack,b=!0,v(this.DONE)},this.abort=function(){p&&(p.abort(),p=null),E=Object.assign({},e),this.responseText="",this.responseXML="",b=a=!0,this.readyState===this.UNSENT||this.readyState===this.OPENED&&!k||this.readyState===this.DONE||(k=!1,v(this.DONE)),this.readyState=this.UNSENT},this.addEventListener=function(e,t){e in n||(n[e]=[]),n[e].push(t)},this.removeEventListener=function(e,t){e in n&&(n[e]=n[e].filter(function(e){return e!==t}))},this.dispatchEvent=function(r){if("function"==typeof m["on"+r]&&(this.readyState===this.DONE?setImmediate(function(){m["on"+r]()}):m["on"+r]()),r in n)for(let e=0,t=n[r].length;e<t;e++)this.readyState===this.DONE?setImmediate(function(){n[r][e].call(m)}):n[r][e].call(m)};var v=function(e){if(!(m.readyState===e||m.readyState===m.UNSENT&&a)&&(m.readyState=e,(g.async||m.readyState<m.OPENED||m.readyState===m.DONE)&&m.dispatchEvent("readystatechange"),m.readyState===m.DONE)){let e;e=a?"abort":b?"error":"load",m.dispatchEvent(e),m.dispatchEvent("loadend")}}}XMLHttpRequest$1.XMLHttpRequest=XMLHttpRequest$1;var XMLHttpRequestModule=Object.freeze(_mergeNamespaces({__proto__:null,default:XMLHttpRequest_1},[XMLHttpRequest_1]));const XMLHttpRequest=XMLHttpRequest_1||XMLHttpRequestModule;var globalThis=global;function pick(r,...e){return e.reduce((e,t)=>(r.hasOwnProperty(t)&&(e[t]=r[t]),e),{})}const NATIVE_SET_TIMEOUT=setTimeout,NATIVE_CLEAR_TIMEOUT=clearTimeout;function installTimerFunctions(e,t){t.useNativeTimers?(e.setTimeoutFn=NATIVE_SET_TIMEOUT.bind(globalThis),e.clearTimeoutFn=NATIVE_CLEAR_TIMEOUT.bind(globalThis)):(e.setTimeoutFn=setTimeout.bind(globalThis),e.clearTimeoutFn=clearTimeout.bind(globalThis))}var Emitter_1=Emitter;function Emitter(e){if(e)return mixin(e)}function mixin(e){for(var t in Emitter.prototype)e[t]=Emitter.prototype[t];return e}Emitter.prototype.on=Emitter.prototype.addEventListener=function(e,t){return this._callbacks=this._callbacks||{},(this._callbacks["$"+e]=this._callbacks["$"+e]||[]).push(t),this},Emitter.prototype.once=function(e,t){function r(){this.off(e,r),t.apply(this,arguments)}return r.fn=t,this.on(e,r),this},Emitter.prototype.off=Emitter.prototype.removeListener=Emitter.prototype.removeAllListeners=Emitter.prototype.removeEventListener=function(e,t){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var r,s=this._callbacks["$"+e];if(!s)return this;if(1==arguments.length)return delete this._callbacks["$"+e],this;for(var o=0;o<s.length;o++)if((r=s[o])===t||r.fn===t){s.splice(o,1);break}return 0===s.length&&delete this._callbacks["$"+e],this},Emitter.prototype.emit=function(e){this._callbacks=this._callbacks||{};for(var t=new Array(arguments.length-1),r=this._callbacks["$"+e],s=1;s<arguments.length;s++)t[s-1]=arguments[s];if(r)for(var s=0,o=(r=r.slice(0)).length;s<o;++s)r[s].apply(this,t);return this},Emitter.prototype.emitReserved=Emitter.prototype.emit,Emitter.prototype.listeners=function(e){return this._callbacks=this._callbacks||{},this._callbacks["$"+e]||[]},Emitter.prototype.hasListeners=function(e){return!!this.listeners(e).length};const PACKET_TYPES=Object.create(null);PACKET_TYPES.open="0",PACKET_TYPES.close="1",PACKET_TYPES.ping="2",PACKET_TYPES.pong="3",PACKET_TYPES.message="4",PACKET_TYPES.upgrade="5",PACKET_TYPES.noop="6";const PACKET_TYPES_REVERSE=Object.create(null);Object.keys(PACKET_TYPES).forEach(e=>{PACKET_TYPES_REVERSE[PACKET_TYPES[e]]=e});const ERROR_PACKET={type:"error",data:"parser error"},encodePacket=({type:e,data:t},r,s)=>{if(t instanceof ArrayBuffer||ArrayBuffer.isView(t)){var o=toBuffer$3(t);return s(encodeBuffer(o,r))}return s(PACKET_TYPES[e]+(t||""))},toBuffer$3=e=>Buffer.isBuffer(e)?e:e instanceof ArrayBuffer?Buffer.from(e):Buffer.from(e.buffer,e.byteOffset,e.byteLength),encodeBuffer=(e,t)=>t?e:"b"+e.toString("base64"),decodePacket=(e,t)=>{if("string"!=typeof e)return{type:"message",data:mapBinary(e,t)};var r=e.charAt(0);if("b"!==r)return PACKET_TYPES_REVERSE[r]?1<e.length?{type:PACKET_TYPES_REVERSE[r],data:e.substring(1)}:{type:PACKET_TYPES_REVERSE[r]}:ERROR_PACKET;e=Buffer.from(e.substring(1),"base64");return{type:"message",data:mapBinary(e,t)}},mapBinary=(e,t)=>{var r=Buffer.isBuffer(e);return"arraybuffer"===t&&r?toArrayBuffer$2(e):e},toArrayBuffer$2=t=>{var e=new ArrayBuffer(t.length);const r=new Uint8Array(e);for(let e=0;e<t.length;e++)r[e]=t[e];return e},SEPARATOR=String.fromCharCode(30),encodePayload=(e,r)=>{const s=e.length,o=new Array(s);let n=0;e.forEach((e,t)=>{encodePacket(e,!1,e=>{o[t]=e,++n===s&&r(o.join(SEPARATOR))})})},decodePayload=(e,t)=>{var r=e.split(SEPARATOR);const s=[];for(let e=0;e<r.length;e++){var o=decodePacket(r[e],t);if(s.push(o),"error"===o.type)break}return s},protocol$1=4;class Transport extends Emitter_1{constructor(e){super(),this.writable=!1,installTimerFunctions(this,e),this.opts=e,this.query=e.query,this.readyState="",this.socket=e.socket}onError(e,t){const r=new Error(e);return r.type="TransportError",r.description=t,super.emit("error",r),this}open(){return"closed"!==this.readyState&&""!==this.readyState||(this.readyState="opening",this.doOpen()),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(e){"open"===this.readyState&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emit("open")}onData(e){e=decodePacket(e,this.socket.binaryType);this.onPacket(e)}onPacket(e){super.emit("packet",e)}onClose(){this.readyState="closed",super.emit("close")}}var prev,alphabet="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),length=64,map={},seed=0,i=0;function encode(e){for(var t="";t=alphabet[e%length]+t,0<(e=Math.floor(e/length)););return t}function decode(e){var t=0;for(i=0;i<e.length;i++)t=t*length+map[e.charAt(i)];return t}function yeast(){var e=encode(+new Date);return e!==prev?(seed=0,prev=e):e+"."+encode(seed++)}for(;i<length;i++)map[alphabet[i]]=i;yeast.encode=encode,yeast.decode=decode;var yeast_1=yeast,parseqs={encode:function(e){var t,r="";for(t in e)e.hasOwnProperty(t)&&(r.length&&(r+="&"),r+=encodeURIComponent(t)+"="+encodeURIComponent(e[t]));return r},decode:function(e){for(var t={},r=e.split("&"),s=0,o=r.length;s<o;s++){var n=r[s].split("=");t[decodeURIComponent(n[0])]=decodeURIComponent(n[1])}return t}};class Polling extends Transport{constructor(){super(...arguments),this.polling=!1}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";const t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let e=0;this.polling&&(e++,this.once("pollComplete",function(){--e||t()})),this.writable||(e++,this.once("drain",function(){--e||t()}))}else t()}poll(){this.polling=!0,this.doPoll(),this.emit("poll")}onData(e){decodePayload(e,this.socket.binaryType).forEach(e=>{if("opening"===this.readyState&&"open"===e.type&&this.onOpen(),"close"===e.type)return this.onClose(),!1;this.onPacket(e)}),"closed"!==this.readyState&&(this.polling=!1,this.emit("pollComplete"),"open"===this.readyState&&this.poll())}doClose(){var e=()=>{this.write([{type:"close"}])};"open"===this.readyState?e():this.once("open",e)}write(e){this.writable=!1,encodePayload(e,e=>{this.doWrite(e,()=>{this.writable=!0,this.emit("drain")})})}uri(){let e=this.query||{};var t=this.opts.secure?"https":"http";let r="";!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=yeast_1()),this.supportsBinary||e.sid||(e.b64=1),this.opts.port&&("https"==t&&443!==Number(this.opts.port)||"http"==t&&80!==Number(this.opts.port))&&(r=":"+this.opts.port);var s=parseqs.encode(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+r+this.opts.path+(s.length?"?"+s:"")}}function empty(){}const hasXHR2=null!=new XMLHttpRequest({xdomain:!1}).responseType;class XHR extends Polling{constructor(t){if(super(t),"undefined"!=typeof location){var r="https:"===location.protocol;let e=location.port;e=e||(r?"443":"80"),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||e!==t.port,this.xs=t.secure!==r}t=t&&t.forceBase64;this.supportsBinary=hasXHR2&&!t}request(e={}){return Object.assign(e,{xd:this.xd,xs:this.xs},this.opts),new Request(this.uri(),e)}doWrite(e,t){const r=this.request({method:"POST",data:e});r.on("success",t),r.on("error",e=>{this.onError("xhr post error",e)})}doPoll(){const e=this.request();e.on("data",this.onData.bind(this)),e.on("error",e=>{this.onError("xhr poll error",e)}),this.pollXhr=e}}class Request extends Emitter_1{constructor(e,t){super(),installTimerFunctions(this,t),this.opts=t,this.method=t.method||"GET",this.uri=e,this.async=!1!==t.async,this.data=void 0!==t.data?t.data:null,this.create()}create(){const e=pick(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this.opts.xd,e.xscheme=!!this.opts.xs;const t=this.xhr=new XMLHttpRequest(e);try{t.open(this.method,this.uri,this.async);try{if(this.opts.extraHeaders)for(var r in t.setDisableHeaderCheck&&t.setDisableHeaderCheck(!0),this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(r)&&t.setRequestHeader(r,this.opts.extraHeaders[r])}catch(e){}if("POST"===this.method)try{t.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(e){}try{t.setRequestHeader("Accept","*/*")}catch(e){}"withCredentials"in t&&(t.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(t.timeout=this.opts.requestTimeout),t.onreadystatechange=()=>{4===t.readyState&&(200===t.status||1223===t.status?this.onLoad():this.setTimeoutFn(()=>{this.onError("number"==typeof t.status?t.status:0)},0))},t.send(this.data)}catch(e){return void this.setTimeoutFn(()=>{this.onError(e)},0)}"undefined"!=typeof document&&(this.index=Request.requestsCount++,Request.requests[this.index]=this)}onSuccess(){this.emit("success"),this.cleanup()}onData(e){this.emit("data",e),this.onSuccess()}onError(e){this.emit("error",e),this.cleanup(!0)}cleanup(e){if(void 0!==this.xhr&&null!==this.xhr){if(this.xhr.onreadystatechange=empty,e)try{this.xhr.abort()}catch(e){}"undefined"!=typeof document&&delete Request.requests[this.index],this.xhr=null}}onLoad(){var e=this.xhr.responseText;null!==e&&this.onData(e)}abort(){this.cleanup()}}if(Request.requestsCount=0,Request.requests={},"undefined"!=typeof document)if("function"==typeof attachEvent)attachEvent("onunload",unloadHandler);else if("function"==typeof addEventListener){const E1="onpagehide"in globalThis?"pagehide":"unload";addEventListener(E1,unloadHandler,!1)}function unloadHandler(){for(var e in Request.requests)Request.requests.hasOwnProperty(e)&&Request.requests[e].abort()}var bufferUtil$1={exports:{}},constants={BINARY_TYPES:["nodebuffer","arraybuffer","fragments"],EMPTY_BUFFER:Buffer.alloc(0),GUID:"258EAFA5-E914-47DA-95CA-C5AB0DC85B11",kForOnEventAttribute:Symbol("kIsForOnEventAttribute"),kListener:Symbol("kListener"),kStatusCode:Symbol("status-code"),kWebSocket:Symbol("websocket"),NOOP:()=>{}};const EMPTY_BUFFER$3=constants["EMPTY_BUFFER"];function concat$1(t,e){if(0===t.length)return EMPTY_BUFFER$3;if(1===t.length)return t[0];const r=Buffer.allocUnsafe(e);let s=0;for(let e=0;e<t.length;e++){var o=t[e];r.set(o,s),s+=o.length}return s<e?r.slice(0,s):r}function _mask(t,r,s,o,n){for(let e=0;e<n;e++)s[o+e]=t[e]^r[3&e]}function _unmask(t,r){for(let e=0;e<t.length;e++)t[e]^=r[3&e]}function toArrayBuffer$1(e){return e.byteLength===e.buffer.byteLength?e.buffer:e.buffer.slice(e.byteOffset,e.byteOffset+e.byteLength)}function toBuffer$2(e){if(toBuffer$2.readOnly=!0,Buffer.isBuffer(e))return e;let t;return e instanceof ArrayBuffer?t=Buffer.from(e):ArrayBuffer.isView(e)?t=Buffer.from(e.buffer,e.byteOffset,e.byteLength):(t=Buffer.from(e),toBuffer$2.readOnly=!1),t}try{const bufferUtil=require("bufferutil");bufferUtil$1.exports={concat:concat$1,mask(e,t,r,s,o){o<48?_mask(e,t,r,s,o):bufferUtil.mask(e,t,r,s,o)},toArrayBuffer:toArrayBuffer$1,toBuffer:toBuffer$2,unmask(e,t){e.length<32?_unmask(e,t):bufferUtil.unmask(e,t)}}}catch(e){bufferUtil$1.exports={concat:concat$1,mask:_mask,toArrayBuffer:toArrayBuffer$1,toBuffer:toBuffer$2,unmask:_unmask}}const kDone=Symbol("kDone"),kRun=Symbol("kRun");class Limiter$1{constructor(e){this[kDone]=()=>{this.pending--,this[kRun]()},this.concurrency=e||1/0,this.jobs=[],this.pending=0}add(e){this.jobs.push(e),this[kRun]()}[kRun](){if(this.pending!==this.concurrency&&this.jobs.length){const e=this.jobs.shift();this.pending++,e(this[kDone])}}}var limiter=Limiter$1;const zlib=require$$0$1,bufferUtil=bufferUtil$1.exports,Limiter=limiter,kStatusCode$2=constants["kStatusCode"],TRAILER=Buffer.from([0,0,255,255]),kPerMessageDeflate=Symbol("permessage-deflate"),kTotalLength=Symbol("total-length"),kCallback=Symbol("callback"),kBuffers=Symbol("buffers"),kError$1=Symbol("error");let zlibLimiter;class PerMessageDeflate$3{constructor(e,t,r){this._maxPayload=0|r,this._options=e||{},this._threshold=void 0!==this._options.threshold?this._options.threshold:1024,this._isServer=!!t,this._deflate=null,this._inflate=null,this.params=null,zlibLimiter||(t=void 0!==this._options.concurrencyLimit?this._options.concurrencyLimit:10,zlibLimiter=new Limiter(t))}static get extensionName(){return"permessage-deflate"}offer(){const e={};return this._options.serverNoContextTakeover&&(e.server_no_context_takeover=!0),this._options.clientNoContextTakeover&&(e.client_no_context_takeover=!0),this._options.serverMaxWindowBits&&(e.server_max_window_bits=this._options.serverMaxWindowBits),this._options.clientMaxWindowBits?e.client_max_window_bits=this._options.clientMaxWindowBits:null==this._options.clientMaxWindowBits&&(e.client_max_window_bits=!0),e}accept(e){return e=this.normalizeParams(e),this.params=this._isServer?this.acceptAsServer(e):this.acceptAsClient(e),this.params}cleanup(){if(this._inflate&&(this._inflate.close(),this._inflate=null),this._deflate){const e=this._deflate[kCallback];this._deflate.close(),this._deflate=null,e&&e(new Error("The deflate stream was closed while data was being processed"))}}acceptAsServer(e){const t=this._options,r=e.find(e=>!(!1===t.serverNoContextTakeover&&e.server_no_context_takeover||e.server_max_window_bits&&(!1===t.serverMaxWindowBits||"number"==typeof t.serverMaxWindowBits&&t.serverMaxWindowBits>e.server_max_window_bits)||"number"==typeof t.clientMaxWindowBits&&!e.client_max_window_bits));if(!r)throw new Error("None of the extension offers can be accepted");return t.serverNoContextTakeover&&(r.server_no_context_takeover=!0),t.clientNoContextTakeover&&(r.client_no_context_takeover=!0),"number"==typeof t.serverMaxWindowBits&&(r.server_max_window_bits=t.serverMaxWindowBits),"number"==typeof t.clientMaxWindowBits?r.client_max_window_bits=t.clientMaxWindowBits:!0!==r.client_max_window_bits&&!1!==t.clientMaxWindowBits||delete r.client_max_window_bits,r}acceptAsClient(e){const t=e[0];if(!1===this._options.clientNoContextTakeover&&t.client_no_context_takeover)throw new Error('Unexpected parameter "client_no_context_takeover"');if(t.client_max_window_bits){if(!1===this._options.clientMaxWindowBits||"number"==typeof this._options.clientMaxWindowBits&&t.client_max_window_bits>this._options.clientMaxWindowBits)throw new Error('Unexpected or invalid parameter "client_max_window_bits"')}else"number"==typeof this._options.clientMaxWindowBits&&(t.client_max_window_bits=this._options.clientMaxWindowBits);return t}normalizeParams(e){return e.forEach(s=>{Object.keys(s).forEach(e=>{let t=s[e];if(1<t.length)throw new Error(`Parameter "${e}" must have only a single value`);if(t=t[0],"client_max_window_bits"===e){if(!0!==t){var r=+t;if(!Number.isInteger(r)||r<8||15<r)throw new TypeError(`Invalid value for parameter "${e}": `+t);t=r}else if(!this._isServer)throw new TypeError(`Invalid value for parameter "${e}": `+t)}else if("server_max_window_bits"===e){r=+t;if(!Number.isInteger(r)||r<8||15<r)throw new TypeError(`Invalid value for parameter "${e}": `+t);t=r}else{if("client_no_context_takeover"!==e&&"server_no_context_takeover"!==e)throw new Error(`Unknown parameter "${e}"`);if(!0!==t)throw new TypeError(`Invalid value for parameter "${e}": `+t)}s[e]=t})}),e}decompress(e,t,s){zlibLimiter.add(r=>{this._decompress(e,t,(e,t)=>{r(),s(e,t)})})}compress(e,t,s){zlibLimiter.add(r=>{this._compress(e,t,(e,t)=>{r(),s(e,t)})})}_decompress(e,t,r){const s=this._isServer?"client":"server";var o;this._inflate||(o=s+"_max_window_bits",o="number"!=typeof this.params[o]?zlib.Z_DEFAULT_WINDOWBITS:this.params[o],this._inflate=zlib.createInflateRaw({...this._options.zlibInflateOptions,windowBits:o}),(this._inflate[kPerMessageDeflate]=this)._inflate[kTotalLength]=0,this._inflate[kBuffers]=[],this._inflate.on("error",inflateOnError),this._inflate.on("data",inflateOnData)),this._inflate[kCallback]=r,this._inflate.write(e),t&&this._inflate.write(TRAILER),this._inflate.flush(()=>{var e=this._inflate[kError$1];if(e)return this._inflate.close(),this._inflate=null,void r(e);e=bufferUtil.concat(this._inflate[kBuffers],this._inflate[kTotalLength]);this._inflate._readableState.endEmitted?(this._inflate.close(),this._inflate=null):(this._inflate[kTotalLength]=0,this._inflate[kBuffers]=[],t&&this.params[s+"_no_context_takeover"]&&this._inflate.reset()),r(null,e)})}_compress(e,t,r){const s=this._isServer?"server":"client";var o;this._deflate||(o=s+"_max_window_bits",o="number"!=typeof this.params[o]?zlib.Z_DEFAULT_WINDOWBITS:this.params[o],this._deflate=zlib.createDeflateRaw({...this._options.zlibDeflateOptions,windowBits:o}),this._deflate[kTotalLength]=0,this._deflate[kBuffers]=[],this._deflate.on("data",deflateOnData)),this._deflate[kCallback]=r,this._deflate.write(e),this._deflate.flush(zlib.Z_SYNC_FLUSH,()=>{if(this._deflate){let e=bufferUtil.concat(this._deflate[kBuffers],this._deflate[kTotalLength]);t&&(e=e.slice(0,e.length-4)),this._deflate[kCallback]=null,this._deflate[kTotalLength]=0,this._deflate[kBuffers]=[],t&&this.params[s+"_no_context_takeover"]&&this._deflate.reset(),r(null,e)}})}}var permessageDeflate=PerMessageDeflate$3;function deflateOnData(e){this[kBuffers].push(e),this[kTotalLength]+=e.length}function inflateOnData(e){this[kTotalLength]+=e.length,this[kPerMessageDeflate]._maxPayload<1||this[kTotalLength]<=this[kPerMessageDeflate]._maxPayload?this[kBuffers].push(e):(this[kError$1]=new RangeError("Max payload size exceeded"),this[kError$1].code="WS_ERR_UNSUPPORTED_MESSAGE_LENGTH",this[kError$1][kStatusCode$2]=1009,this.removeListener("data",inflateOnData),this.reset())}function inflateOnError(e){this[kPerMessageDeflate]._inflate=null,e[kStatusCode$2]=1007,this[kCallback](e)}var validation={exports:{}};const tokenChars$1=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,1,1,1,1,1,0,0,1,1,0,1,1,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,0,1,0];function isValidStatusCode$2(e){return 1e3<=e&&e<=1014&&1004!==e&&1005!==e&&1006!==e||3e3<=e&&e<=4999}function _isValidUTF8(e){var t=e.length;let r=0;for(;r<t;)if(0==(128&e[r]))r++;else if(192==(224&e[r])){if(r+1===t||128!=(192&e[r+1])||192==(254&e[r]))return!1;r+=2}else if(224==(240&e[r])){if(r+2>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||224===e[r]&&128==(224&e[r+1])||237===e[r]&&160==(224&e[r+1]))return!1;r+=3}else{if(240!=(248&e[r]))return!1;if(r+3>=t||128!=(192&e[r+1])||128!=(192&e[r+2])||128!=(192&e[r+3])||240===e[r]&&128==(240&e[r+1])||244===e[r]&&143<e[r+1]||244<e[r])return!1;r+=4}return!0}try{const isValidUTF8=require("utf-8-validate");validation.exports={isValidStatusCode:isValidStatusCode$2,isValidUTF8(e){return(e.length<150?_isValidUTF8:isValidUTF8)(e)},tokenChars:tokenChars$1}}catch(e){validation.exports={isValidStatusCode:isValidStatusCode$2,isValidUTF8:_isValidUTF8,tokenChars:tokenChars$1}}const Writable=require$$0$2["Writable"],PerMessageDeflate$2=permessageDeflate,{BINARY_TYPES:BINARY_TYPES$1,EMPTY_BUFFER:EMPTY_BUFFER$2,kStatusCode:kStatusCode$1,kWebSocket:kWebSocket$1}=constants,{concat,toArrayBuffer,unmask}=bufferUtil$1.exports,{isValidStatusCode:isValidStatusCode$1,isValidUTF8}=validation.exports,GET_INFO=0,GET_PAYLOAD_LENGTH_16=1,GET_PAYLOAD_LENGTH_64=2,GET_MASK=3,GET_DATA=4,INFLATING=5;class Receiver$1 extends Writable{constructor(e={}){super(),this._binaryType=e.binaryType||BINARY_TYPES$1[0],this._extensions=e.extensions||{},this._isServer=!!e.isServer,this._maxPayload=0|e.maxPayload,this._skipUTF8Validation=!!e.skipUTF8Validation,this[kWebSocket$1]=void 0,this._bufferedBytes=0,this._buffers=[],this._compressed=!1,this._payloadLength=0,this._mask=void 0,this._fragmented=0,this._masked=!1,this._fin=!1,this._opcode=0,this._totalPayloadLength=0,this._messageLength=0,this._fragments=[],this._state=GET_INFO,this._loop=!1}_write(e,t,r){if(8===this._opcode&&this._state==GET_INFO)return r();this._bufferedBytes+=e.length,this._buffers.push(e),this.startLoop(r)}consume(e){if(this._bufferedBytes-=e,e===this._buffers[0].length)return this._buffers.shift();if(e<this._buffers[0].length){const s=this._buffers[0];return this._buffers[0]=s.slice(e),s.slice(0,e)}const t=Buffer.allocUnsafe(e);do{const o=this._buffers[0];var r=t.length-e;e>=o.length?t.set(this._buffers.shift(),r):(t.set(new Uint8Array(o.buffer,o.byteOffset,e),r),this._buffers[0]=o.slice(e)),e-=o.length}while(0<e);return t}startLoop(e){let t;this._loop=!0;do{switch(this._state){case GET_INFO:t=this.getInfo();break;case GET_PAYLOAD_LENGTH_16:t=this.getPayloadLength16();break;case GET_PAYLOAD_LENGTH_64:t=this.getPayloadLength64();break;case GET_MASK:this.getMask();break;case GET_DATA:t=this.getData(e);break;default:return void(this._loop=!1)}}while(this._loop);e(t)}getInfo(){if(this._bufferedBytes<2)this._loop=!1;else{var e=this.consume(2);if(0!=(48&e[0]))return this._loop=!1,error(RangeError,"RSV2 and RSV3 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_2_3");var t=64==(64&e[0]);if(t&&!this._extensions[PerMessageDeflate$2.extensionName])return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(this._fin=128==(128&e[0]),this._opcode=15&e[0],this._payloadLength=127&e[1],0===this._opcode){if(t)return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(!this._fragmented)return this._loop=!1,error(RangeError,"invalid opcode 0",!0,1002,"WS_ERR_INVALID_OPCODE");this._opcode=this._fragmented}else if(1===this._opcode||2===this._opcode){if(this._fragmented)return this._loop=!1,error(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");this._compressed=t}else{if(!(7<this._opcode&&this._opcode<11))return this._loop=!1,error(RangeError,"invalid opcode "+this._opcode,!0,1002,"WS_ERR_INVALID_OPCODE");if(!this._fin)return this._loop=!1,error(RangeError,"FIN must be set",!0,1002,"WS_ERR_EXPECTED_FIN");if(t)return this._loop=!1,error(RangeError,"RSV1 must be clear",!0,1002,"WS_ERR_UNEXPECTED_RSV_1");if(125<this._payloadLength)return this._loop=!1,error(RangeError,"invalid payload length "+this._payloadLength,!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH")}if(this._fin||this._fragmented||(this._fragmented=this._opcode),this._masked=128==(128&e[1]),this._isServer){if(!this._masked)return this._loop=!1,error(RangeError,"MASK must be set",!0,1002,"WS_ERR_EXPECTED_MASK")}else if(this._masked)return this._loop=!1,error(RangeError,"MASK must be clear",!0,1002,"WS_ERR_UNEXPECTED_MASK");if(126===this._payloadLength)this._state=GET_PAYLOAD_LENGTH_16;else{if(127!==this._payloadLength)return this.haveLength();this._state=GET_PAYLOAD_LENGTH_64}}}getPayloadLength16(){if(!(this._bufferedBytes<2))return this._payloadLength=this.consume(2).readUInt16BE(0),this.haveLength();this._loop=!1}getPayloadLength64(){if(!(this._bufferedBytes<8)){const t=this.consume(8);var e=t.readUInt32BE(0);return e>Math.pow(2,21)-1?(this._loop=!1,error(RangeError,"Unsupported WebSocket frame: payload length > 2^53 - 1",!1,1009,"WS_ERR_UNSUPPORTED_DATA_PAYLOAD_LENGTH")):(this._payloadLength=e*Math.pow(2,32)+t.readUInt32BE(4),this.haveLength())}this._loop=!1}haveLength(){if(this._payloadLength&&this._opcode<8&&(this._totalPayloadLength+=this._payloadLength,this._totalPayloadLength>this._maxPayload&&0<this._maxPayload))return this._loop=!1,error(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH");this._masked?this._state=GET_MASK:this._state=GET_DATA}getMask(){this._bufferedBytes<4?this._loop=!1:(this._mask=this.consume(4),this._state=GET_DATA)}getData(e){let t=EMPTY_BUFFER$2;if(this._payloadLength){if(this._bufferedBytes<this._payloadLength)return void(this._loop=!1);t=this.consume(this._payloadLength),this._masked&&unmask(t,this._mask)}return 7<this._opcode?this.controlMessage(t):this._compressed?(this._state=INFLATING,void this.decompress(t,e)):(t.length&&(this._messageLength=this._totalPayloadLength,this._fragments.push(t)),this.dataMessage())}decompress(e,r){const t=this._extensions[PerMessageDeflate$2.extensionName];t.decompress(e,this._fin,(e,t)=>{if(e)return r(e);if(t.length){if(this._messageLength+=t.length,this._messageLength>this._maxPayload&&0<this._maxPayload)return r(error(RangeError,"Max payload size exceeded",!1,1009,"WS_ERR_UNSUPPORTED_MESSAGE_LENGTH"));this._fragments.push(t)}t=this.dataMessage();if(t)return r(t);this.startLoop(r)})}dataMessage(){if(this._fin){var t=this._messageLength,r=this._fragments;if(this._totalPayloadLength=0,this._messageLength=0,this._fragmented=0,this._fragments=[],2===this._opcode){let e;e="nodebuffer"===this._binaryType?concat(r,t):"arraybuffer"===this._binaryType?toArrayBuffer(concat(r,t)):r,this.emit("message",e,!0)}else{t=concat(r,t);if(!this._skipUTF8Validation&&!isValidUTF8(t))return this._loop=!1,error(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("message",t,!1)}}this._state=GET_INFO}controlMessage(e){if(8===this._opcode)if(this._loop=!1,0===e.length)this.emit("conclude",1005,EMPTY_BUFFER$2),this.end();else{if(1===e.length)return error(RangeError,"invalid payload length 1",!0,1002,"WS_ERR_INVALID_CONTROL_PAYLOAD_LENGTH");var t=e.readUInt16BE(0);if(!isValidStatusCode$1(t))return error(RangeError,"invalid status code "+t,!0,1002,"WS_ERR_INVALID_CLOSE_CODE");var r=e.slice(2);if(!this._skipUTF8Validation&&!isValidUTF8(r))return error(Error,"invalid UTF-8 sequence",!0,1007,"WS_ERR_INVALID_UTF8");this.emit("conclude",t,r),this.end()}else 9===this._opcode?this.emit("ping",e):this.emit("pong",e);this._state=GET_INFO}}var receiver=Receiver$1;function error(e,t,r,s,o){const n=new e(r?"Invalid WebSocket frame: "+t:t);return Error.captureStackTrace(n,error),n.code=o,n[kStatusCode$1]=s,n}const randomFillSync=require$$5["randomFillSync"],PerMessageDeflate$1=permessageDeflate,EMPTY_BUFFER$1=constants["EMPTY_BUFFER"],isValidStatusCode=validation.exports["isValidStatusCode"],{mask:applyMask,toBuffer:toBuffer$1}=bufferUtil$1.exports,mask=Buffer.alloc(4);class Sender$1{constructor(e,t){this._extensions=t||{},this._socket=e,this._firstFragment=!0,this._compress=!1,this._bufferedBytes=0,this._deflating=!1,this._queue=[]}static frame(e,t){var r=t.mask&&t.readOnly;let s=t.mask?6:2,o=e.length;65536<=e.length?(s+=8,o=127):125<e.length&&(s+=2,o=126);const n=Buffer.allocUnsafe(r?e.length+s:s);return n[0]=t.fin?128|t.opcode:t.opcode,t.rsv1&&(n[0]|=64),n[1]=o,126===o?n.writeUInt16BE(e.length,2):127===o&&(n.writeUInt32BE(0,2),n.writeUInt32BE(e.length,6)),t.mask?(randomFillSync(mask,0,4),n[1]|=128,n[s-4]=mask[0],n[s-3]=mask[1],n[s-2]=mask[2],n[s-1]=mask[3],r?(applyMask(e,mask,n,s,e.length),[n]):(applyMask(e,mask,e,0,e.length),[n,e])):[n,e]}close(e,t,r,s){let o;if(void 0===e)o=EMPTY_BUFFER$1;else{if("number"!=typeof e||!isValidStatusCode(e))throw new TypeError("First argument must be a valid error code number");if(void 0!==t&&t.length){var n=Buffer.byteLength(t);if(123<n)throw new RangeError("The message must not be greater than 123 bytes");o=Buffer.allocUnsafe(2+n),o.writeUInt16BE(e,0),"string"==typeof t?o.write(t,2):o.set(t,2)}else o=Buffer.allocUnsafe(2),o.writeUInt16BE(e,0)}this._deflating?this.enqueue([this.doClose,o,r,s]):this.doClose(o,r,s)}doClose(e,t,r){this.sendFrame(Sender$1.frame(e,{fin:!0,rsv1:!1,opcode:8,mask:t,readOnly:!1}),r)}ping(e,t,r){e=toBuffer$1(e);if(125<e.length)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPing,e,t,toBuffer$1.readOnly,r]):this.doPing(e,t,toBuffer$1.readOnly,r)}doPing(e,t,r,s){this.sendFrame(Sender$1.frame(e,{fin:!0,rsv1:!1,opcode:9,mask:t,readOnly:r}),s)}pong(e,t,r){e=toBuffer$1(e);if(125<e.length)throw new RangeError("The data size must not be greater than 125 bytes");this._deflating?this.enqueue([this.doPong,e,t,toBuffer$1.readOnly,r]):this.doPong(e,t,toBuffer$1.readOnly,r)}doPong(e,t,r,s){this.sendFrame(Sender$1.frame(e,{fin:!0,rsv1:!1,opcode:10,mask:t,readOnly:r}),s)}send(e,t,r){var s=toBuffer$1(e),e=this._extensions[PerMessageDeflate$1.extensionName];let o=t.binary?2:1,n=t.compress;this._firstFragment?(this._firstFragment=!1,n&&e&&e.params[e._isServer?"server_no_context_takeover":"client_no_context_takeover"]&&(n=s.length>=e._threshold),this._compress=n):(n=!1,o=0),t.fin&&(this._firstFragment=!0),e?(e={fin:t.fin,rsv1:n,opcode:o,mask:t.mask,readOnly:toBuffer$1.readOnly},this._deflating?this.enqueue([this.dispatch,s,this._compress,e,r]):this.dispatch(s,this._compress,e,r)):this.sendFrame(Sender$1.frame(s,{fin:t.fin,rsv1:!1,opcode:o,mask:t.mask,readOnly:toBuffer$1.readOnly}),r)}dispatch(o,e,n,i){if(e){const t=this._extensions[PerMessageDeflate$1.extensionName];this._bufferedBytes+=o.length,this._deflating=!0,t.compress(o,n.fin,(e,t)=>{if(this._socket.destroyed){var r=new Error("The socket was closed while data was being compressed");"function"==typeof i&&i(r);for(let e=0;e<this._queue.length;e++){const s=this._queue[e][4];"function"==typeof s&&s(r)}}else this._bufferedBytes-=o.length,this._deflating=!1,n.readOnly=!1,this.sendFrame(Sender$1.frame(t,n),i),this.dequeue()})}else this.sendFrame(Sender$1.frame(o,n),i)}dequeue(){for(;!this._deflating&&this._queue.length;){const e=this._queue.shift();this._bufferedBytes-=e[1].length,Reflect.apply(e[0],this,e.slice(1))}}enqueue(e){this._bufferedBytes+=e[1].length,this._queue.push(e)}sendFrame(e,t){2===e.length?(this._socket.cork(),this._socket.write(e[0]),this._socket.write(e[1],t),this._socket.uncork()):this._socket.write(e[0],t)}}var sender=Sender$1;const{kForOnEventAttribute:kForOnEventAttribute$1,kListener:kListener$1}=constants,kCode=Symbol("kCode"),kData=Symbol("kData"),kError=Symbol("kError"),kMessage=Symbol("kMessage"),kReason=Symbol("kReason"),kTarget=Symbol("kTarget"),kType=Symbol("kType"),kWasClean=Symbol("kWasClean");class Event{constructor(e){this[kTarget]=null,this[kType]=e}get target(){return this[kTarget]}get type(){return this[kType]}}Object.defineProperty(Event.prototype,"target",{enumerable:!0}),Object.defineProperty(Event.prototype,"type",{enumerable:!0});class CloseEvent extends Event{constructor(e,t={}){super(e),this[kCode]=void 0===t.code?0:t.code,this[kReason]=void 0===t.reason?"":t.reason,this[kWasClean]=void 0!==t.wasClean&&t.wasClean}get code(){return this[kCode]}get reason(){return this[kReason]}get wasClean(){return this[kWasClean]}}Object.defineProperty(CloseEvent.prototype,"code",{enumerable:!0}),Object.defineProperty(CloseEvent.prototype,"reason",{enumerable:!0}),Object.defineProperty(CloseEvent.prototype,"wasClean",{enumerable:!0});class ErrorEvent extends Event{constructor(e,t={}){super(e),this[kError]=void 0===t.error?null:t.error,this[kMessage]=void 0===t.message?"":t.message}get error(){return this[kError]}get message(){return this[kMessage]}}Object.defineProperty(ErrorEvent.prototype,"error",{enumerable:!0}),Object.defineProperty(ErrorEvent.prototype,"message",{enumerable:!0});class MessageEvent extends Event{constructor(e,t={}){super(e),this[kData]=void 0===t.data?null:t.data}get data(){return this[kData]}}Object.defineProperty(MessageEvent.prototype,"data",{enumerable:!0});const EventTarget={addEventListener(e,s,t={}){let r;if("message"===e)r=function(e,t){const r=new MessageEvent("message",{data:t?e:e.toString()});r[kTarget]=this,s.call(this,r)};else if("close"===e)r=function(e,t){const r=new CloseEvent("close",{code:e,reason:t.toString(),wasClean:this._closeFrameReceived&&this._closeFrameSent});r[kTarget]=this,s.call(this,r)};else if("error"===e)r=function(e){const t=new ErrorEvent("error",{error:e,message:e.message});t[kTarget]=this,s.call(this,t)};else{if("open"!==e)return;r=function(){const e=new Event("open");e[kTarget]=this,s.call(this,e)}}r[kForOnEventAttribute$1]=!!t[kForOnEventAttribute$1],r[kListener$1]=s,t.once?this.once(e,r):this.on(e,r)},removeEventListener(e,t){for(const r of this.listeners(e))if(r[kListener$1]===t&&!r[kForOnEventAttribute$1]){this.removeListener(e,r);break}}};var eventTarget={CloseEvent:CloseEvent,ErrorEvent:ErrorEvent,Event:Event,EventTarget:EventTarget,MessageEvent:MessageEvent};const tokenChars=validation.exports["tokenChars"];function push(e,t,r){void 0===e[t]?e[t]=[r]:e[t].push(r)}function parse$1(t){var r=Object.create(null);let s=Object.create(null),o=!1,e=!1,n=!1,i,a,c=-1,h=-1,l=-1,d=0;for(;d<t.length;d++)if(h=t.charCodeAt(d),void 0===i)if(-1===l&&1===tokenChars[h])-1===c&&(c=d);else if(0===d||32!==h&&9!==h){if(59!==h&&44!==h)throw new SyntaxError("Unexpected character at index "+d);if(-1===c)throw new SyntaxError("Unexpected character at index "+d);-1===l&&(l=d);var u=t.slice(c,l);44===h?(push(r,u,s),s=Object.create(null)):i=u,c=l=-1}else-1===l&&-1!==c&&(l=d);else if(void 0===a)if(-1===l&&1===tokenChars[h])-1===c&&(c=d);else if(32===h||9===h)-1===l&&-1!==c&&(l=d);else if(59===h||44===h){if(-1===c)throw new SyntaxError("Unexpected character at index "+d);-1===l&&(l=d),push(s,t.slice(c,l),!0),44===h&&(push(r,i,s),s=Object.create(null),i=void 0),c=l=-1}else{if(61!==h||-1===c||-1!==l)throw new SyntaxError("Unexpected character at index "+d);a=t.slice(c,d),c=l=-1}else if(e){if(1!==tokenChars[h])throw new SyntaxError("Unexpected character at index "+d);-1===c?c=d:o=o||!0,e=!1}else if(n)if(1===tokenChars[h])-1===c&&(c=d);else if(34===h&&-1!==c)n=!1,l=d;else{if(92!==h)throw new SyntaxError("Unexpected character at index "+d);e=!0}else if(34===h&&61===t.charCodeAt(d-1))n=!0;else if(-1===l&&1===tokenChars[h])-1===c&&(c=d);else if(-1===c||32!==h&&9!==h){if(59!==h&&44!==h)throw new SyntaxError("Unexpected character at index "+d);{if(-1===c)throw new SyntaxError("Unexpected character at index "+d);-1===l&&(l=d);let e=t.slice(c,l);o&&(e=e.replace(/\\/g,""),o=!1),push(s,a,e),44===h&&(push(r,i,s),s=Object.create(null),i=void 0),a=void 0,c=l=-1}}else-1===l&&(l=d);if(-1===c||n||32===h||9===h)throw new SyntaxError("Unexpected end of input");-1===l&&(l=d);const p=t.slice(c,l);return void 0===i?push(r,p,s):(void 0===a?push(s,p,!0):o?push(s,a,p.replace(/\\/g,"")):push(s,a,p),push(r,i,s)),r}function format$1(r){return Object.keys(r).map(e=>{let t=r[e];return Array.isArray(t)||(t=[t]),t.map(r=>[e].concat(Object.keys(r).map(t=>{let e=r[t];return Array.isArray(e)||(e=[e]),e.map(e=>!0===e?t:t+"="+e).join("; ")})).join("; ")).join(", ")}).join(", ")}var extension={format:format$1,parse:parse$1};const EventEmitter=require$$0$3,https=require$$4,http=require$$3,net=require$$3$1,tls=require$$4$1,{randomBytes,createHash}=require$$5,URL=require$$1["URL"],PerMessageDeflate=permessageDeflate,Receiver=receiver,Sender=sender,{BINARY_TYPES,EMPTY_BUFFER,GUID,kForOnEventAttribute,kListener,kStatusCode,kWebSocket,NOOP}=constants,{EventTarget:{addEventListener:addEventListener$1,removeEventListener:removeEventListener$1}}=eventTarget,{format,parse}=extension,toBuffer=bufferUtil$1.exports["toBuffer"],readyStates=["CONNECTING","OPEN","CLOSING","CLOSED"],subprotocolRegex=/^[!#$%&'*+\-.0-9A-Z^_`|a-z~]+$/,protocolVersions=[8,13],closeTimeout=3e4;class WebSocket$1 extends EventEmitter{constructor(e,t,r){super(),this._binaryType=BINARY_TYPES[0],this._closeCode=1006,this._closeFrameReceived=!1,this._closeFrameSent=!1,this._closeMessage=EMPTY_BUFFER,this._closeTimer=null,this._extensions={},this._protocol="",this._readyState=WebSocket$1.CONNECTING,this._receiver=null,this._sender=null,(this._socket=null)!==e?(this._bufferedAmount=0,this._isServer=!1,void(this._redirects=0)===t?t=[]:Array.isArray(t)||(t="object"==typeof t&&null!==t?(r=t,[]):[t]),initAsClient(this,e,t,r)):this._isServer=!0}get binaryType(){return this._binaryType}set binaryType(e){BINARY_TYPES.includes(e)&&(this._binaryType=e,this._receiver&&(this._receiver._binaryType=e))}get bufferedAmount(){return this._socket?this._socket._writableState.length+this._sender._bufferedBytes:this._bufferedAmount}get extensions(){return Object.keys(this._extensions).join()}get onclose(){return null}get onerror(){return null}get onopen(){return null}get onmessage(){return null}get protocol(){return this._protocol}get readyState(){return this._readyState}get url(){return this._url}setSocket(e,t,r){const s=new Receiver({binaryType:this.binaryType,extensions:this._extensions,isServer:this._isServer,maxPayload:r.maxPayload,skipUTF8Validation:r.skipUTF8Validation});this._sender=new Sender(e,this._extensions),this._receiver=s,this._socket=e,s[kWebSocket]=this,e[kWebSocket]=this,s.on("conclude",receiverOnConclude),s.on("drain",receiverOnDrain),s.on("error",receiverOnError),s.on("message",receiverOnMessage),s.on("ping",receiverOnPing),s.on("pong",receiverOnPong),e.setTimeout(0),e.setNoDelay(),0<t.length&&e.unshift(t),e.on("close",socketOnClose),e.on("data",socketOnData),e.on("end",socketOnEnd),e.on("error",socketOnError),this._readyState=WebSocket$1.OPEN,this.emit("open")}emitClose(){if(!this._socket)return this._readyState=WebSocket$1.CLOSED,void this.emit("close",this._closeCode,this._closeMessage);this._extensions[PerMessageDeflate.extensionName]&&this._extensions[PerMessageDeflate.extensionName].cleanup(),this._receiver.removeAllListeners(),this._readyState=WebSocket$1.CLOSED,this.emit("close",this._closeCode,this._closeMessage)}close(e,t){if(this.readyState!==WebSocket$1.CLOSED){if(this.readyState===WebSocket$1.CONNECTING)return abortHandshake(this,this._req,"WebSocket was closed before the connection was established");this.readyState!==WebSocket$1.CLOSING?(this._readyState=WebSocket$1.CLOSING,this._sender.close(e,t,!this._isServer,e=>{e||(this._closeFrameSent=!0,(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end())}),this._closeTimer=setTimeout(this._socket.destroy.bind(this._socket),closeTimeout)):this._closeFrameSent&&(this._closeFrameReceived||this._receiver._writableState.errorEmitted)&&this._socket.end()}}ping(e,t,r){if(this.readyState===WebSocket$1.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===WebSocket$1.OPEN?(void 0===t&&(t=!this._isServer),this._sender.ping(e||EMPTY_BUFFER,t,r)):sendAfterClose(this,e,r)}pong(e,t,r){if(this.readyState===WebSocket$1.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");"function"==typeof e?(r=e,e=t=void 0):"function"==typeof t&&(r=t,t=void 0),"number"==typeof e&&(e=e.toString()),this.readyState===WebSocket$1.OPEN?(void 0===t&&(t=!this._isServer),this._sender.pong(e||EMPTY_BUFFER,t,r)):sendAfterClose(this,e,r)}send(e,t,r){if(this.readyState===WebSocket$1.CONNECTING)throw new Error("WebSocket is not open: readyState 0 (CONNECTING)");if("function"==typeof t&&(r=t,t={}),"number"==typeof e&&(e=e.toString()),this.readyState===WebSocket$1.OPEN){const s={binary:"string"!=typeof e,mask:!this._isServer,compress:!0,fin:!0,...t};this._extensions[PerMessageDeflate.extensionName]||(s.compress=!1),this._sender.send(e||EMPTY_BUFFER,s,r)}else sendAfterClose(this,e,r)}terminate(){if(this.readyState!==WebSocket$1.CLOSED){if(this.readyState===WebSocket$1.CONNECTING)return abortHandshake(this,this._req,"WebSocket was closed before the connection was established");this._socket&&(this._readyState=WebSocket$1.CLOSING,this._socket.destroy())}}}Object.defineProperty(WebSocket$1,"CONNECTING",{enumerable:!0,value:readyStates.indexOf("CONNECTING")}),Object.defineProperty(WebSocket$1.prototype,"CONNECTING",{enumerable:!0,value:readyStates.indexOf("CONNECTING")}),Object.defineProperty(WebSocket$1,"OPEN",{enumerable:!0,value:readyStates.indexOf("OPEN")}),Object.defineProperty(WebSocket$1.prototype,"OPEN",{enumerable:!0,value:readyStates.indexOf("OPEN")}),Object.defineProperty(WebSocket$1,"CLOSING",{enumerable:!0,value:readyStates.indexOf("CLOSING")}),Object.defineProperty(WebSocket$1.prototype,"CLOSING",{enumerable:!0,value:readyStates.indexOf("CLOSING")}),Object.defineProperty(WebSocket$1,"CLOSED",{enumerable:!0,value:readyStates.indexOf("CLOSED")}),Object.defineProperty(WebSocket$1.prototype,"CLOSED",{enumerable:!0,value:readyStates.indexOf("CLOSED")}),["binaryType","bufferedAmount","extensions","protocol","readyState","url"].forEach(e=>{Object.defineProperty(WebSocket$1.prototype,e,{enumerable:!0})}),["open","error","close","message"].forEach(r=>{Object.defineProperty(WebSocket$1.prototype,"on"+r,{enumerable:!0,get(){for(const e of this.listeners(r))if(e[kForOnEventAttribute])return e[kListener];return null},set(e){for(const t of this.listeners(r))if(t[kForOnEventAttribute]){this.removeListener(r,t);break}"function"==typeof e&&this.addEventListener(r,e,{[kForOnEventAttribute]:!0})}})}),WebSocket$1.prototype.addEventListener=addEventListener$1,WebSocket$1.prototype.removeEventListener=removeEventListener$1;var PacketType,websocket=WebSocket$1;function initAsClient(n,s,o,i){const a={protocolVersion:protocolVersions[1],maxPayload:104857600,skipUTF8Validation:!1,perMessageDeflate:!0,followRedirects:!1,maxRedirects:10,...i,createConnection:void 0,socketPath:void 0,hostname:void 0,protocol:void 0,timeout:void 0,method:void 0,host:void 0,path:void 0,port:void 0};if(!protocolVersions.includes(a.protocolVersion))throw new RangeError(`Unsupported protocol version: ${a.protocolVersion} `+`(supported versions: ${protocolVersions.join(", ")})`);let e;if(s instanceof URL)e=s,n._url=s.href;else{try{e=new URL(s)}catch(e){throw new SyntaxError("Invalid URL: "+s)}n._url=s}var t="wss:"===e.protocol,r="ws+unix:"===e.protocol;if("ws:"!==e.protocol&&!t&&!r)throw new SyntaxError('The URL\'s protocol must be one of "ws:", "wss:", or "ws+unix:"');if(r&&!e.pathname)throw new SyntaxError("The URL's pathname is empty");if(e.hash)throw new SyntaxError("The URL contains a fragment identifier");var c=t?443:80;const h=randomBytes(16).toString("base64"),l=(t?https:http).get,d=new Set;let u;if(a.createConnection=t?tlsConnect:netConnect,a.defaultPort=a.defaultPort||c,a.port=e.port||c,a.host=e.hostname.startsWith("[")?e.hostname.slice(1,-1):e.hostname,a.headers={"Sec-WebSocket-Version":a.protocolVersion,"Sec-WebSocket-Key":h,Connection:"Upgrade",Upgrade:"websocket",...a.headers},a.path=e.pathname+e.search,a.timeout=a.handshakeTimeout,a.perMessageDeflate&&(u=new PerMessageDeflate(!0!==a.perMessageDeflate?a.perMessageDeflate:{},!1,a.maxPayload),a.headers["Sec-WebSocket-Extensions"]=format({[PerMessageDeflate.extensionName]:u.offer()})),o.length){for(const f of o){if("string"!=typeof f||!subprotocolRegex.test(f)||d.has(f))throw new SyntaxError("An invalid or duplicated subprotocol was specified");d.add(f)}a.headers["Sec-WebSocket-Protocol"]=o.join(",")}a.origin&&(a.protocolVersion<13?a.headers["Sec-WebSocket-Origin"]=a.origin:a.headers.Origin=a.origin),(e.username||e.password)&&(a.auth=e.username+":"+e.password),r&&(r=a.path.split(":"),a.socketPath=r[0],a.path=r[1]);let p=n._req=l(a);a.timeout&&p.on("timeout",()=>{abortHandshake(n,p,"Opening handshake has timed out")}),p.on("error",e=>{null===p||p.aborted||(p=n._req=null,n._readyState=WebSocket$1.CLOSING,n.emit("error",e),n.emitClose())}),p.on("response",e=>{var t=e.headers.location,r=e.statusCode;t&&a.followRedirects&&300<=r&&r<400?++n._redirects>a.maxRedirects?abortHandshake(n,p,"Maximum redirects exceeded"):(p.abort(),t=new URL(t,s),initAsClient(n,t,o,i)):n.emit("unexpected-response",p,e)||abortHandshake(n,p,"Unexpected server response: "+e.statusCode)}),p.on("upgrade",(t,r,s)=>{if(n.emit("upgrade",t),n.readyState===WebSocket$1.CONNECTING){p=n._req=null;var o=createHash("sha1").update(h+GUID).digest("base64");if(t.headers["sec-websocket-accept"]===o){o=t.headers["sec-websocket-protocol"];let e;if(void 0!==o?d.size?d.has(o)||(e="Server sent an invalid subprotocol"):e="Server sent a subprotocol but none was requested":d.size&&(e="Server sent no subprotocol"),e)abortHandshake(n,r,e);else{o&&(n._protocol=o);t=t.headers["sec-websocket-extensions"];if(void 0!==t){if(!u)return void abortHandshake(n,r,"Server sent a Sec-WebSocket-Extensions header but no extension was requested");let e;try{e=parse(t)}catch(e){return void abortHandshake(n,r,"Invalid Sec-WebSocket-Extensions header")}t=Object.keys(e);if(1!==t.length||t[0]!==PerMessageDeflate.extensionName)return void abortHandshake(n,r,"Server indicated an extension that was not requested");try{u.accept(e[PerMessageDeflate.extensionName])}catch(e){return void abortHandshake(n,r,"Invalid Sec-WebSocket-Extensions header")}n._extensions[PerMessageDeflate.extensionName]=u}n.setSocket(r,s,{maxPayload:a.maxPayload,skipUTF8Validation:a.skipUTF8Validation})}}else abortHandshake(n,r,"Invalid Sec-WebSocket-Accept header")}})}function netConnect(e){return e.path=e.socketPath,net.connect(e)}function tlsConnect(e){return e.path=void 0,e.servername||""===e.servername||(e.servername=net.isIP(e.host)?"":e.host),tls.connect(e)}function abortHandshake(e,t,r){e._readyState=WebSocket$1.CLOSING;r=new Error(r);Error.captureStackTrace(r,abortHandshake),t.setHeader?(t.abort(),t.socket&&!t.socket.destroyed&&t.socket.destroy(),t.once("abort",e.emitClose.bind(e)),e.emit("error",r)):(t.destroy(r),t.once("error",e.emit.bind(e,"error")),t.once("close",e.emitClose.bind(e)))}function sendAfterClose(e,t,r){t&&(t=toBuffer(t).length,e._socket?e._sender._bufferedBytes+=t:e._bufferedAmount+=t),r&&r(new Error(`WebSocket is not open: readyState ${e.readyState} `+`(${readyStates[e.readyState]})`))}function receiverOnConclude(e,t){const r=this[kWebSocket];r._closeFrameReceived=!0,r._closeMessage=t,r._closeCode=e,void 0!==r._socket[kWebSocket]&&(r._socket.removeListener("data",socketOnData),process.nextTick(resume,r._socket),1005===e?r.close():r.close(e,t))}function receiverOnDrain(){this[kWebSocket]._socket.resume()}function receiverOnError(e){const t=this[kWebSocket];void 0!==t._socket[kWebSocket]&&(t._socket.removeListener("data",socketOnData),process.nextTick(resume,t._socket),t.close(e[kStatusCode])),t.emit("error",e)}function receiverOnFinish(){this[kWebSocket].emitClose()}function receiverOnMessage(e,t){this[kWebSocket].emit("message",e,t)}function receiverOnPing(e){const t=this[kWebSocket];t.pong(e,!t._isServer,NOOP),t.emit("ping",e)}function receiverOnPong(e){this[kWebSocket].emit("pong",e)}function resume(e){e.resume()}function socketOnClose(){const e=this[kWebSocket];this.removeListener("close",socketOnClose),this.removeListener("data",socketOnData),this.removeListener("end",socketOnEnd),e._readyState=WebSocket$1.CLOSING;let t;this._readableState.endEmitted||e._closeFrameReceived||e._receiver._writableState.errorEmitted||null===(t=e._socket.read())||e._receiver.write(t),e._receiver.end(),this[kWebSocket]=void 0,clearTimeout(e._closeTimer),e._receiver._writableState.finished||e._receiver._writableState.errorEmitted?e.emitClose():(e._receiver.on("error",receiverOnFinish),e._receiver.on("finish",receiverOnFinish))}function socketOnData(e){this[kWebSocket]._receiver.write(e)||this.pause()}function socketOnEnd(){const e=this[kWebSocket];e._readyState=WebSocket$1.CLOSING,e._receiver.end(),this.end()}function socketOnError(){const e=this[kWebSocket];this.removeListener("error",socketOnError),this.on("error",NOOP),e&&(e._readyState=WebSocket$1.CLOSING,this.destroy())}const WebSocket=WebSocket$1,usingBrowserWebSocket=!1,defaultBinaryType="nodebuffer",nextTick=process.nextTick,isReactNative="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class WS extends Transport{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(this.check()){var e=this.uri(),t=this.opts.protocols;const r=isReactNative?{}:pick(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(r.headers=this.opts.extraHeaders);try{this.ws=usingBrowserWebSocket&&!isReactNative?t?new WebSocket(e,t):new WebSocket(e):new WebSocket(e,t,r)}catch(e){return this.emit("error",e)}this.ws.binaryType=this.socket.binaryType||defaultBinaryType,this.addEventListeners()}}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=this.onClose.bind(this),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const r=t[e],s=e===t.length-1;encodePacket(r,this.supportsBinary,e=>{const t={};r.options&&(t.compress=r.options.compress),this.opts.perMessageDeflate&&("string"==typeof e?Buffer.byteLength(e):e.length)<this.opts.perMessageDeflate.threshold&&(t.compress=!1);try{usingBrowserWebSocket||this.ws.send(e,t)}catch(e){}s&&nextTick(()=>{this.writable=!0,this.emit("drain")},this.setTimeoutFn)})}}doClose(){void 0!==this.ws&&(this.ws.close(),this.ws=null)}uri(){let e=this.query||{};var t=this.opts.secure?"wss":"ws";let r="";this.opts.port&&("wss"==t&&443!==Number(this.opts.port)||"ws"==t&&80!==Number(this.opts.port))&&(r=":"+this.opts.port),this.opts.timestampRequests&&(e[this.opts.timestampParam]=yeast_1()),this.supportsBinary||(e.b64=1);var s=parseqs.encode(e);return t+"://"+(-1!==this.opts.hostname.indexOf(":")?"["+this.opts.hostname+"]":this.opts.hostname)+r+this.opts.path+(s.length?"?"+s:"")}check(){return!(!WebSocket||"__initialize"in WebSocket&&this.name===WS.prototype.name)}}const transports={websocket:WS,polling:XHR};class Socket$1 extends Emitter_1{constructor(e,t={}){super(),e&&"object"==typeof e&&(t=e,e=null),e?(e=parseuri(e),t.hostname=e.host,t.secure="https"===e.protocol||"wss"===e.protocol,t.port=e.port,e.query&&(t.query=e.query)):t.host&&(t.hostname=parseuri(t.host).host),installTimerFunctions(this,t),this.secure=null!=t.secure?t.secure:"undefined"!=typeof location&&"https:"===location.protocol,t.hostname&&!t.port&&(t.port=this.secure?"443":"80"),this.hostname=t.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=t.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=t.transports||["polling","websocket"],this.readyState="",this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!0},t),this.opts.path=this.opts.path.replace(/\/$/,"")+"/","string"==typeof this.opts.query&&(this.opts.query=parseqs.decode(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,"function"==typeof addEventListener&&(this.opts.closeOnBeforeunload&&addEventListener("beforeunload",()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},!1),"localhost"!==this.hostname&&(this.offlineEventListener=()=>{this.onClose("transport close")},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(e){const t=clone(this.opts.query);t.EIO=protocol$1,t.transport=e,this.id&&(t.sid=this.id);var r=Object.assign({},this.opts.transportOptions[e],this.opts,{query:t,socket:this,hostname:this.hostname,secure:this.secure,port:this.port});return new transports[e](r)}open(){let e;if(this.opts.rememberUpgrade&&Socket$1.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket"))e="websocket";else{if(0===this.transports.length)return void this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);e=this.transports[0]}this.readyState="opening";try{e=this.createTransport(e)}catch(e){return this.transports.shift(),void this.open()}e.open(),this.setTransport(e)}setTransport(e){this.transport&&this.transport.removeAllListeners(),(this.transport=e).on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",()=>{this.onClose("transport close")})}probe(e){let r=this.createTransport(e),s=!1;Socket$1.priorWebsocketSuccess=!1;const t=()=>{s||(r.send([{type:"ping",data:"probe"}]),r.once("packet",e=>{if(!s)if("pong"===e.type&&"probe"===e.data)this.upgrading=!0,this.emitReserved("upgrading",r),r&&(Socket$1.priorWebsocketSuccess="websocket"===r.name,this.transport.pause(()=>{s||"closed"!==this.readyState&&(h(),this.setTransport(r),r.send([{type:"upgrade"}]),this.emitReserved("upgrade",r),r=null,this.upgrading=!1,this.flush())}));else{const t=new Error("probe error");t.transport=r.name,this.emitReserved("upgradeError",t)}}))};function o(){s||(s=!0,h(),r.close(),r=null)}const n=e=>{const t=new Error("probe error: "+e);t.transport=r.name,o(),this.emitReserved("upgradeError",t)};function i(){n("transport closed")}function a(){n("socket closed")}function c(e){r&&e.name!==r.name&&o()}const h=()=>{r.removeListener("open",t),r.removeListener("error",n),r.removeListener("close",i),this.off("close",a),this.off("upgrading",c)};r.once("open",t),r.once("error",n),r.once("close",i),this.once("close",a),this.once("upgrading",c),r.open()}onOpen(){if(this.readyState="open",Socket$1.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush(),"open"===this.readyState&&this.opts.upgrade&&this.transport.pause){let e=0;for(var t=this.upgrades.length;e<t;e++)this.probe(this.upgrades[e])}}onPacket(e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",e),this.emitReserved("heartbeat"),e.type){case"open":this.onHandshake(JSON.parse(e.data));break;case"ping":this.resetPingTimeout(),this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":const t=new Error("server error");t.code=e.data,this.onError(t);break;case"message":this.emitReserved("data",e.data),this.emitReserved("message",e.data)}}onHandshake(e){this.emitReserved("handshake",e),this.id=e.sid,this.transport.query.sid=e.sid,this.upgrades=this.filterUpgrades(e.upgrades),this.pingInterval=e.pingInterval,this.pingTimeout=e.pingTimeout,this.onOpen(),"closed"!==this.readyState&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),(this.prevBufferLen=0)===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){"closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length&&(this.transport.send(this.writeBuffer),this.prevBufferLen=this.writeBuffer.length,this.emitReserved("flush"))}write(e,t,r){return this.sendPacket("message",e,t,r),this}send(e,t,r){return this.sendPacket("message",e,t,r),this}sendPacket(e,t,r,s){"function"==typeof t&&(s=t,t=void 0),"function"==typeof r&&(s=r,r=null),"closing"!==this.readyState&&"closed"!==this.readyState&&((r=r||{}).compress=!1!==r.compress,this.emitReserved("packetCreate",r={type:e,data:t,options:r}),this.writeBuffer.push(r),s&&this.once("flush",s),this.flush())}close(){const e=()=>{this.onClose("forced close"),this.transport.close()},t=()=>{this.off("upgrade",t),this.off("upgradeError",t),e()},r=()=>{this.once("upgrade",t),this.once("upgradeError",t)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{(this.upgrading?r:e)()}):(this.upgrading?r:e)()),this}onError(e){Socket$1.priorWebsocketSuccess=!1,this.emitReserved("error",e),this.onClose("transport error",e)}onClose(e,t){"opening"!==this.readyState&&"open"!==this.readyState&&"closing"!==this.readyState||(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),"function"==typeof removeEventListener&&removeEventListener("offline",this.offlineEventListener,!1),this.readyState="closed",this.id=null,this.emitReserved("close",e,t),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(e){const t=[];let r=0;for(var s=e.length;r<s;r++)~this.transports.indexOf(e[r])&&t.push(e[r]);return t}}function clone(e){const t={};for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r]);return t}Socket$1.protocol=protocol$1,Socket$1.protocol;const withNativeArrayBuffer="function"==typeof ArrayBuffer,isView=e=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(e):e.buffer instanceof ArrayBuffer,toString=Object.prototype.toString,withNativeBlob="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===toString.call(Blob),withNativeFile="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===toString.call(File);function isBinary(e){return withNativeArrayBuffer&&(e instanceof ArrayBuffer||isView(e))||withNativeBlob&&e instanceof Blob||withNativeFile&&e instanceof File}function hasBinary(r,e){if(!r||"object"!=typeof r)return!1;if(Array.isArray(r)){for(let e=0,t=r.length;e<t;e++)if(hasBinary(r[e]))return!0;return!1}if(isBinary(r))return!0;if(r.toJSON&&"function"==typeof r.toJSON&&1===arguments.length)return hasBinary(r.toJSON(),!0);for(const t in r)if(Object.prototype.hasOwnProperty.call(r,t)&&hasBinary(r[t]))return!0;return!1}function deconstructPacket(e){var t=[],r=e.data;const s=e;return s.data=_deconstructPacket(r,t),s.attachments=t.length,{packet:s,buffers:t}}function _deconstructPacket(t,r){if(!t)return t;if(isBinary(t)){var e={_placeholder:!0,num:r.length};return r.push(t),e}if(Array.isArray(t)){const s=new Array(t.length);for(let e=0;e<t.length;e++)s[e]=_deconstructPacket(t[e],r);return s}if("object"!=typeof t||t instanceof Date)return t;{const o={};for(const n in t)t.hasOwnProperty(n)&&(o[n]=_deconstructPacket(t[n],r));return o}}function reconstructPacket(e,t){return e.data=_reconstructPacket(e.data,t),e.attachments=void 0,e}function _reconstructPacket(t,r){if(!t)return t;if(t&&t._placeholder)return r[t.num];if(Array.isArray(t))for(let e=0;e<t.length;e++)t[e]=_reconstructPacket(t[e],r);else if("object"==typeof t)for(const e in t)t.hasOwnProperty(e)&&(t[e]=_reconstructPacket(t[e],r));return t}const protocol=5;!function(e){e[e.CONNECT=0]="CONNECT",e[e.DISCONNECT=1]="DISCONNECT",e[e.EVENT=2]="EVENT",e[e.ACK=3]="ACK",e[e.CONNECT_ERROR=4]="CONNECT_ERROR",e[e.BINARY_EVENT=5]="BINARY_EVENT",e[e.BINARY_ACK=6]="BINARY_ACK"}(PacketType=PacketType||{});class Encoder{encode(e){return e.type!==PacketType.EVENT&&e.type!==PacketType.ACK||!hasBinary(e)?[this.encodeAsString(e)]:(e.type=e.type===PacketType.EVENT?PacketType.BINARY_EVENT:PacketType.BINARY_ACK,this.encodeAsBinary(e))}encodeAsString(e){let t=""+e.type;return e.type!==PacketType.BINARY_EVENT&&e.type!==PacketType.BINARY_ACK||(t+=e.attachments+"-"),e.nsp&&"/"!==e.nsp&&(t+=e.nsp+","),null!=e.id&&(t+=e.id),null!=e.data&&(t+=JSON.stringify(e.data)),t}encodeAsBinary(e){var t=deconstructPacket(e),e=this.encodeAsString(t.packet);const r=t.buffers;return r.unshift(e),r}}class Decoder extends Emitter_1{constructor(){super()}add(e){let t;if("string"==typeof e)t=this.decodeString(e),t.type===PacketType.BINARY_EVENT||t.type===PacketType.BINARY_ACK?(this.reconstructor=new BinaryReconstructor(t),0===t.attachments&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t);else{if(!isBinary(e)&&!e.base64)throw new Error("Unknown type: "+e);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t))}}decodeString(e){let t=0;const r={type:Number(e.charAt(0))};if(void 0===PacketType[r.type])throw new Error("unknown packet type "+r.type);if(r.type===PacketType.BINARY_EVENT||r.type===PacketType.BINARY_ACK){for(var s=t+1;"-"!==e.charAt(++t)&&t!=e.length;);s=e.substring(s,t);if(s!=Number(s)||"-"!==e.charAt(t))throw new Error("Illegal attachments");r.attachments=Number(s)}if("/"===e.charAt(t+1)){for(var o=t+1;++t;){if(","===e.charAt(t))break;if(t===e.length)break}r.nsp=e.substring(o,t)}else r.nsp="/";o=e.charAt(t+1);if(""!==o&&Number(o)==o){for(var n=t+1;++t;){var i=e.charAt(t);if(null==i||Number(i)!=i){--t;break}if(t===e.length)break}r.id=Number(e.substring(n,t+1))}if(e.charAt(++t)){n=tryParse(e.substr(t));if(!Decoder.isPayloadValid(r.type,n))throw new Error("invalid payload");r.data=n}return r}static isPayloadValid(e,t){switch(e){case PacketType.CONNECT:return"object"==typeof t;case PacketType.DISCONNECT:return void 0===t;case PacketType.CONNECT_ERROR:return"string"==typeof t||"object"==typeof t;case PacketType.EVENT:case PacketType.BINARY_EVENT:return Array.isArray(t)&&0<t.length;case PacketType.ACK:case PacketType.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&this.reconstructor.finishedReconstruction()}}function tryParse(e){try{return JSON.parse(e)}catch(e){return!1}}class BinaryReconstructor{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length!==this.reconPack.attachments)return null;e=reconstructPacket(this.reconPack,this.buffers);return this.finishedReconstruction(),e}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}var parser=Object.freeze({__proto__:null,protocol:protocol,get PacketType(){return PacketType},Encoder:Encoder,Decoder:Decoder});function on(e,t,r){return e.on(t,r),function(){e.off(t,r)}}const RESERVED_EVENTS=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class Socket extends Emitter_1{constructor(e,t,r){super(),this.connected=!1,this.disconnected=!0,this.receiveBuffer=[],this.sendBuffer=[],this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,r&&r.auth&&(this.auth=r.auth),this.io._autoConnect&&this.open()}subEvents(){var e;this.subs||(e=this.io,this.subs=[on(e,"open",this.onopen.bind(this)),on(e,"packet",this.onpacket.bind(this)),on(e,"error",this.onerror.bind(this)),on(e,"close",this.onclose.bind(this))])}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(RESERVED_EVENTS.hasOwnProperty(e))throw new Error('"'+e+'" is a reserved event name');t.unshift(e);const r={type:PacketType.EVENT,data:t,options:{}};r.options.compress=!1!==this.flags.compress,"function"==typeof t[t.length-1]&&(this.acks[this.ids]=t.pop(),r.id=this.ids++);t=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!t||!this.connected)||(this.connected?this.packet(r):this.sendBuffer.push(r)),this.flags={},this}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){"function"==typeof this.auth?this.auth(e=>{this.packet({type:PacketType.CONNECT,data:e})}):this.packet({type:PacketType.CONNECT,data:this.auth})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e){this.connected=!1,this.disconnected=!0,delete this.id,this.emitReserved("disconnect",e)}onpacket(e){var t;if(e.nsp===this.nsp)switch(e.type){case PacketType.CONNECT:e.data&&e.data.sid?(t=e.data.sid,this.onconnect(t)):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case PacketType.EVENT:case PacketType.BINARY_EVENT:this.onevent(e);break;case PacketType.ACK:case PacketType.BINARY_ACK:this.onack(e);break;case PacketType.DISCONNECT:this.ondisconnect();break;case PacketType.CONNECT_ERROR:const r=new Error(e.data.message);r.data=e.data.data,this.emitReserved("connect_error",r)}}onevent(e){const t=e.data||[];null!=e.id&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length)for(const t of this._anyListeners.slice())t.apply(this,e);super.emit.apply(this,e)}ack(t){const r=this;let s=!1;return function(...e){s||(s=!0,r.packet({type:PacketType.ACK,id:t,data:e}))}}onack(e){const t=this.acks[e.id];"function"==typeof t&&(t.apply(this,e.data),delete this.acks[e.id])}onconnect(e){this.id=e,this.connected=!0,this.disconnected=!1,this.emitBuffered(),this.emitReserved("connect")}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>this.packet(e)),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:PacketType.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(t){if(!this._anyListeners)return this;if(t){const r=this._anyListeners;for(let e=0;e<r.length;e++)if(t===r[e])return r.splice(e,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}}var backo2=Backoff;function Backoff(e){this.ms=(e=e||{}).min||100,this.max=e.max||1e4,this.factor=e.factor||2,this.jitter=0<e.jitter&&e.jitter<=1?e.jitter:0,this.attempts=0}Backoff.prototype.duration=function(){var e,t,r=this.ms*Math.pow(this.factor,this.attempts++);return this.jitter&&(e=Math.random(),t=Math.floor(e*this.jitter*r),r=0==(1&Math.floor(10*e))?r-t:r+t),0|Math.min(r,this.max)},Backoff.prototype.reset=function(){this.attempts=0},Backoff.prototype.setMin=function(e){this.ms=e},Backoff.prototype.setMax=function(e){this.max=e},Backoff.prototype.setJitter=function(e){this.jitter=e};class Manager extends Emitter_1{constructor(e,t){var r;super(),this.nsps={},this.subs=[],e&&"object"==typeof e&&(t=e,e=void 0),(t=t||{}).path=t.path||"/socket.io",this.opts=t,installTimerFunctions(this,t),this.reconnection(!1!==t.reconnection),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(r=t.randomizationFactor)&&void 0!==r?r:.5),this.backoff=new backo2({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==t.timeout?2e4:t.timeout),this._readyState="closed",this.uri=e;const s=t.parser||parser;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=!1!==t.autoConnect,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return void 0===e?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return void 0===e?this._reconnectionDelay:(this._reconnectionDelay=e,null!==(t=this.backoff)&&void 0!==t&&t.setMin(e),this)}randomizationFactor(e){var t;return void 0===e?this._randomizationFactor:(this._randomizationFactor=e,null!==(t=this.backoff)&&void 0!==t&&t.setJitter(e),this)}reconnectionDelayMax(e){var t;return void 0===e?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,null!==(t=this.backoff)&&void 0!==t&&t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new Socket$1(this.uri,this.opts);const e=this.engine,r=this;this._readyState="opening",this.skipReconnect=!1;const s=on(e,"open",function(){r.onopen(),t&&t()});var o=on(e,"error",e=>{r.cleanup(),r._readyState="closed",this.emitReserved("error",e),t?t(e):r.maybeReconnectOnOpen()});if(!1!==this._timeout){var n=this._timeout;0===n&&s();const i=this.setTimeoutFn(()=>{s(),e.close(),e.emit("error",new Error("timeout"))},n);this.opts.autoUnref&&i.unref(),this.subs.push(function(){clearTimeout(i)})}return this.subs.push(s),this.subs.push(o),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");var e=this.engine;this.subs.push(on(e,"ping",this.onping.bind(this)),on(e,"data",this.ondata.bind(this)),on(e,"error",this.onerror.bind(this)),on(e,"close",this.onclose.bind(this)),on(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){this.decoder.add(e)}ondecoded(e){this.emitReserved("packet",e)}onerror(e){this.emitReserved("error",e)}socket(e,t){let r=this.nsps[e];return r||(r=new Socket(this,e,t),this.nsps[e]=r),r}_destroy(e){for(const t of Object.keys(this.nsps)){const e=this.nsps[t];if(e.active)return}this._close()}_packet(t){var r=this.encoder.encode(t);for(let e=0;e<r.length;e++)this.engine.write(r[e],t.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,"opening"===this._readyState&&this.cleanup(),this.backoff.reset(),this._readyState="closed",this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{var e=this.backoff.duration();this._reconnecting=!0;const r=this.setTimeoutFn(()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open(e=>{e?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",e)):t.onreconnect()}))},e);this.opts.autoUnref&&r.unref(),this.subs.push(function(){clearTimeout(r)})}}onreconnect(){var e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}}const cache={};function lookup(e,t){"object"==typeof e&&(t=e,e=void 0);var r=url(e,(t=t||{}).path||"/socket.io"),s=r.source,o=r.id,e=r.path,e=cache[o]&&e in cache[o].nsps,e=t.forceNew||t["force new connection"]||!1===t.multiplex||e;let n;return n=e?new Manager(s,t):(cache[o]||(cache[o]=new Manager(s,t)),cache[o]),r.query&&!t.query&&(t.query=r.queryKey),n.socket(r.path,t)}Object.assign(lookup,{Manager:Manager,Socket:Socket,io:lookup,connect:lookup});class SignalingController extends ColdBrew{static WS;static myPeerConnection;static STUN_URL={iceServers:[{urls:["stun:stun.l.google.com:19302","stun:stun1.l.google.com:19302","stun:stun2.l.google.com:19302","stun:stun3.l.google.com:19302","stun:stun4.l.google.com:19302"]}]};constructor(){super(),SignalingController.WS=lookup(),console.log("%c HELLO ColdBrew","color: hotpink; font-size:40px; background:black"),console.log("%c [ColdBrew] connected socket","color: skyblue",SignalingController.WS)}static async init(){return new SignalingController}static async joinRoom(e,t){super.RoomName=e,await this.init(),SignalingController.WS.emit("join-room",e,t),this.connectSocket(e)}static attachRemoteVideo(t){SignalingController.myPeerConnection=new RTCPeerConnection(SignalingController.STUN_URL),SignalingController.myPeerConnection.addEventListener("icecandidate",e=>{console.log("%c sent icecandidate","%color: red",e);var t=super.RoomName;SignalingController.WS.emit("ice",e.candidate,t)}),SignalingController.myPeerConnection.addEventListener("track",e=>{console.log("got remote peer stream",e.streams[0]),t.srcObject=e.streams[0]});const r=ColdBrew.MyStream;r.getTracks().map(e=>SignalingController.myPeerConnection.addTrack(e,r))}static connectSocket(t){SignalingController.WS.on("Room-Info",(e,t)=>{console.log("%c [ColdBrew] Join Room|User",e,t)}),SignalingController.WS.on("success-join",async(e,t)=>{console.log("%c [ColdBrew] success join","color: #f3602b",`roomname: ${e}, username: `+t);e=await SignalingController.myPeerConnection.createOffer();SignalingController.myPeerConnection.setLocalDescription(e);t=ColdBrew.RoomName;SignalingController.WS.emit("offer",e,t),console.log("%c [ColdBrew] sent offer","color: #e64607bc",e),SignalingController.WS.on("answer",async e=>{console.log("%c [ColdBrew] received answer","color: #e64607bc",e),await SignalingController.myPeerConnection.setRemoteDescription(e)})}),SignalingController.WS.on("offer",async e=>{console.log("%c [ColdBrew] received offer",e,"color: #05c088"),await SignalingController.myPeerConnection.setRemoteDescription(e);e=await SignalingController.myPeerConnection.createAnswer();SignalingController.myPeerConnection.setLocalDescription(e),SignalingController.WS.emit("answer",e,t),console.log("%c [ColdBrew] sent answer","color: #e64607bc",e)}),SignalingController.WS.on("icecandidate",e=>{console.log("%c [ColdBrew] received icecandidate","color: #d3d61e",e),SignalingController.myPeerConnection.addIceCandidate(e)})}static changeCamera(e){if(SignalingController.myPeerConnection){const r=super.MyStream;if("video"===e){var t=r.getVideoTracks()[0];const o=SignalingController.myPeerConnection.getSenders().find(e=>"video"===e.track?.kind);return console.log("%c [ColdBrew] changed camera","color: orangered"),void o?.replaceTrack(t)}t=r.getAudioTracks()[0];const s=SignalingController.myPeerConnection.getSenders().find(e=>"audio"===e.track?.kind);return console.log("%c [ColdBrew] changed mic","color: orangered"),void s?.replaceTrack(t)}console.error("Stream not found")}}export{ColdBrew,GetUserDevices,GetUserDevicesError,SignalingController};
